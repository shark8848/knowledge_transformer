# 元数据新增编辑接口定义表

## 基本信息
- 服务名称：元数据新增编辑接口
- 请求方：知识库管理
- 响应方：知识库管理
- 服务地址：`http://{IP地址}:{端口}/km/sagentPlatform/metadata/addOrUpdateMetadata`
- 请求方式：POST
- 编码格式：UTF-8
- 数据格式：JSON
- Content-Type：`application/json`
- 接口类型：知识库管理平台接口

## 入参字段（Body）
| 父参数 | 参数 | 类型 | 长度 | 必选 | 说明 |
|---|---|---|---|---|---|
| root | task_name | string | - | 是 | 任务名称 |
| root | priority | string | - | 否 | 优先级：`low`/`normal`/`high`，默认 `normal` |
| root | mode | string | - | 否 | 执行模式：`async`（默认，入队）或 `sync`（同步返回结果，仅单文件小体积） |
| root | callback_url | string | - | 否 | 回调 URL，异步完成后推送结果 |
| root | storage | object | - | 否 | 对象存储覆盖配置（不填则用服务端默认） |
| storage | endpoint | string | - | 否 | 对象存储地址，如 `http://minio:9000` |
| storage | access_key | string | - | 否 | 存储访问密钥 |
| storage | secret_key | string | - | 否 | 存储密钥 |
| storage | bucket | string | - | 否 | 目标桶名 |
| root | files | array | - | 是 | 待转换文件列表 |
| files[] | source_format | string | - | 是 | 源格式，如 `doc`、`svg`、`wav` |
| files[] | target_format | string | - | 是 | 目标格式，如 `docx`、`png`、`mp3` |
| files[] | input_url | string | - | 否 | 下载 URL（三选一） |
| files[] | object_key | string | - | 否 | 对象键名（三选一） |
| files[] | base64_data | string | - | 否 | 内联 base64 数据（三选一） |
| files[] | filename | string | - | 否 | 文件名，常配合 base64_data 使用 |
| files[] | size_mb | number | - | 是 | 文件大小（MB），用于校验 |
| files[] | page_limit | number | - | 否 | 文档页数裁剪，仅 `doc/docx/html/ppt/pptx`，与 duration_seconds 互斥 |
| files[] | duration_seconds | number | - | 否 | 音视频/动图时长裁剪，仅音视频/gif，互斥 |

## 出参字段（ResBean）
| 父参数 | 参数 | 类型 | 长度 | 必选 | 说明 |
|---|---|---|---|---|---|
| root | errCode | string | V6 | 是 | 接口返回码；成功：`000000`；失败：`000001`/`999999` 等 |
| root | errMsg | string | V200 | 是 | 返回消息描述 |
| root | status | boolean | - | 是 | 业务处理状态，`true` 成功，`false` 失败 |
| root | data | object | - | 是 | `/api/v1/convert` 返回体（见下） |
| data | status | string | - | 是 | `accepted`/`success`/`failure` |
| data | task_id | string | - | 否 | 任务 ID |
| data | message | string | - | 否 | 描述信息 |
| data | error_code | string | - | 否 | 失败时错误码（如 `ERR_FORMAT_UNSUPPORTED`） |
| data | error_status | number | - | 否 | 失败时 HTTP 状态码 |
| data | results | array | - | 否 | 同步或回调时的结果列表 |
| results[] | source | string | - | 是 | 源格式 |
| results[] | target | string | - | 是 | 目标格式 |
| results[] | status | string | - | 是 | `success`/`failed` |
| results[] | object_key | string | - | 否 | 输出对象键 |
| results[] | output_path | string | - | 否 | 本地输出路径（若存在） |
| results[] | metadata | object | - | 否 | 插件返回的元数据（如 page_limit/duration/notes） |
| results[] | reason | string | - | 否 | 失败原因（含 source 定位） |

## 报文样例

### 入参示例
```json
{
  "task_name": "batch-office-conversion",
  "priority": "high",
  "mode": "async",
  "callback_url": "https://your-service.com/webhook/conversion-complete",
  "storage": {
    "endpoint": "http://minio:9000",
    "access_key": "your-ak",
    "secret_key": "your-sk",
    "bucket": "custom-bucket"
  },
  "files": [
    {
      "source_format": "doc",
      "target_format": "docx",
      "input_url": "https://storage.example.com/documents/report.doc",
      "object_key": "uploads/2025/report.doc",
      "filename": "report.doc",
      "size_mb": 2.5
    },
    {
      "source_format": "svg",
      "target_format": "png",
      "input_url": "https://storage.example.com/images/diagram.svg",
      "size_mb": 0.8,
      "page_limit": null,
      "duration_seconds": null
    },
    {
      "source_format": "wav",
      "target_format": "mp3",
      "object_key": "audio/interview.wav",
      "size_mb": 45.2,
      "duration_seconds": 30
    },
    {
      "source_format": "html",
      "target_format": "pdf",
      "base64_data": "PGh0bWw+PGJvZHk+PGgxPkJhc2U2NCBIVE1MPC9oMT48L2JvZHk+PC9odG1sPg==",
      "filename": "inline.html",
      "size_mb": 0.001,
      "page_limit": 1
    }
  ]
}
```

### 出参示例（异步入队）
```json
{
  "errCode": "000000",
  "errMsg": "success",
  "status": true,
  "data": {
    "status": "accepted",
    "task_id": "a3f7e9d2-4c5b-4e8a-9f2d-1a6b8c3e5d7f",
    "message": "Task accepted and scheduled for conversion"
  }
}
```

### 出参示例（同步成功）
```json
{
  "errCode": "000000",
  "errMsg": "success",
  "status": true,
  "data": {
    "status": "success",
    "task_id": "4b52c3e6-5c2a-4f9b-9d3c-17e7f6e3e111",
    "message": "Task completed synchronously",
    "results": [
      {
        "source": "docx",
        "target": "pdf",
        "status": "success",
        "object_key": "converted/4b52c3e6-5c2a-4f9b-9d3c-17e7f6e3e111/report.pdf",
        "output_path": null,
        "metadata": {"note": "Converted via LibreOffice soffice", "page_limit": 5}
      }
    ]
  }
}
```

### 出参示例（失败，含源定位）
```json
{
  "errCode": "000001",
  "errMsg": "Unsupported format doc->mp4 (source=https://example.com/report.doc)",
  "status": false,
  "data": {
    "status": "failure",
    "error_code": "ERR_FORMAT_UNSUPPORTED",
    "error_status": 400,
    "message": "Unsupported format doc->mp4 (source=https://example.com/report.doc)"
  }
}
```
